<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<div class="col">
            <a href="/admin/product/add" class="btn btn-dark">Add products </a>
            <div class="table-responsive">
                <table class="table table-striped" id="admin-product-list-table">
                    <thead>
                        <tr>
                            <th>Img</th>
                            <th>Item</th>
                            <th>SKU</th>
                            <th>Stock</th>
                            <th>Category</th>
                            <th>Color</th>
                            <th>Base Price</th>
                            <th>ProductOffer</th>
                            <th>Offer Action</th>
                            <th>Status</th>
                            <th>Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each products}}
                        <tr>
                        <td><img src="/images/backend/products/{{this.sku}}/{{getImage this.productImage 0}}" alt="Item image 1" class="index-image"></td>
                        <td>{{this.productName}}</td>
                        <td class="text-wrap" style="width: 10rem;">{{this.sku}}</td>
                        <td>{{count this.variantDetails}}</td>
                        <td>{{getIndex2 this.categoryDetails 0 "name"}}</td>
                        <td>{{this.color}}</td>
                        <td>Rs.{{getVariantPrice this.variantDetails "small" "offerPrice"}}.00</td>
                        <td>{{this.productOffer}} %</td>
                        {{#if (offerNill this.productOffer)}}
                        <td><button onclick="addOffer('{{this._id}}')" class="btn btn-secondary">Add</button></td>
                        {{else}}
                        <td><button onclick="removeOffer('{{this._id}}')" class="btn btn-secondary">Remove</button></td>
                        {{/if}}
                        <td>{{this.status}}</td>
                        <td>
                            <button onclick="fetchProductDetails('{{this._id}}')" class="btn btn-success" type="button">
                            <i class="fa-solid fa-eye"></i>
                            </button>
                            <a href="/admin/product/edit?id={{this._id}}" class="btn btn-warning"><i class="fa-solid fa-pencil"></i></a>
                            {{#if this.isBlocked}}
                            <a href="/admin/product/unblock?id={{this._id}}" class="text-decoration-none text-primary">Unblock</a>
                            {{else}}
                            <a href="/admin/product/block?id={{this._id}}" class="text-decoration-none text-warning">Block</a>
                            {{/if}}
                        </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            {{!-- Product View modal --}}
            <div class="modal modal-lg fade" id="productViewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Product Details</h4>
                            <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h5 id="product-title"></h5>
                            <p id="product-description"></p>
                            <table class="table table-stripped">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Category</th>
                                        <th>Color</th>
                                        <th>Stock</th>
                                        <th>Base Price</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr></tr>
                                        <td id="product-sku"></td>
                                        <td id="product-category"></td>
                                        <td id="product-color"></td>
                                        <td id="product-stock"></td>
                                        <td id="product-price"></td>
                                        <td id="product-status"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <h6 class="mt-3" id="variant-title">Variant Details</h6>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Avl.Stock</th>
                                        <th>Price</th>
                                        <th>Sale Price</th>
                                        <th>Product Offer</th>
                                        <th>Category Offer</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="small-size">Small</td>
                                        <td id="small-stock"></td>
                                        <td id="small-price"></td>
                                        <td id="small-offerPrice"></td>
                                        <td id="small-productOffer"></td>
                                        <td id="small-categoryOffer"></td>
                                    </tr>
                                    <tr>
                                        <td id="medium-size">Medium</td>
                                        <td id="medium-stock"></td>
                                        <td id="medium-price"></td>
                                        <td id="medium-offerPrice"></td>
                                        <td id="medium-productOffer"></td>
                                        <td id="medium-categoryOffer"></td>
                                    </tr>
                                    <tr>
                                        <td id="large-size">Large</td>
                                        <td id="large-stock"></td>
                                        <td id="large-price"></td>
                                        <td id="large-offerPrice"></td>
                                        <td id="large-productOffer"></td>
                                        <td id="large-categoryOffer"></td>
                                    </tr>
                                </tbody>
                            </table>

                            <h5>Images</h5>
                            <div class="img-container d-flex gap-3">
                                <img src="" alt="" id="view-modal-img-1" class="view-modal-images shadow rounded">
                                <img src="" alt="" id="view-modal-img-2" class="view-modal-images shadow rounded">
                                <img src="" alt="" id="view-modal-img-3" class="view-modal-images shadow rounded">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    var modal = new bootstrap.Modal(document.getElementById('productViewModal'))

    function fetchProductDetails(id){
        fetch(`/admin/product/details?id=${id}`)
            .then((response) => {
                //console.log('entered to the then part')
                if(!response.ok){
                    throw new Error(`New HTTP Error status : ${response.status}`)
                }
                //console.log('response converted to json')
                return response.json()
            })
            .then((data) => {
                //console.log(data)
                (function(){
                    //console.log('iife executed')
                    //console.log(data.product)
                    document.getElementById('product-title').innerHTML = data.product.productName
                    document.getElementById('product-description').innerHTML = data.product.productDescription
                    document.getElementById('product-sku').innerHTML = data.product.sku
                    document.getElementById('product-category').innerHTML = data.product.categoryDetaisl[0].name
                    document.getElementById('product-color').innerHTML = data.product.color
                    document.getElementById('product-price').innerHTML = `Rs.${data.product.variantDetails[0].regularPrice}`
                    document.getElementById('product-stock').innerHTML = Number(data.product.variantDetails[0].quantity) + Number(data.product.variantDetails[1].quantity) + Number(data.product.variantDetails[2].quantity)
                    document.getElementById('product-status').innerHTML = data.product.style

                    document.getElementById('small-stock').innerHTML = data.product.variantDetails[0].quantity
                    document.getElementById('small-price').innerHTML = `Rs.${data.product.variantDetails[0].regularPrice}`
                    document.getElementById('small-offerPrice').innerHTML = `Rs.${data.product.variantDetails[0].offerPrice}`
                    document.getElementById('small-productOffer').innerHTML = `${data.product.productOffer} %`
                    document.getElementById('small-categoryOffer').innerHTML = `${data.product.categoryDetaisl[0].categoryOffer} %`

                    document.getElementById('medium-stock').innerHTML = data.product.variantDetails[1].quantity
                    document.getElementById('medium-price').innerHTML = `Rs.${data.product.variantDetails[1].regularPrice}`
                    document.getElementById('medium-offerPrice').innerHTML = `Rs.${data.product.variantDetails[1].offerPrice}`
                    document.getElementById('medium-productOffer').innerHTML = `${data.product.productOffer} %`
                    document.getElementById('medium-categoryOffer').innerHTML = `${data.product.categoryDetaisl[0].categoryOffer} %`

                    document.getElementById('large-stock').innerHTML = data.product.variantDetails[2].quantity
                    document.getElementById('large-price').innerHTML = `Rs.${data.product.variantDetails[2].regularPrice}`
                    document.getElementById('large-offerPrice').innerHTML = `Rs.${data.product.variantDetails[2].offerPrice}`
                    document.getElementById('large-productOffer').innerHTML = `${data.product.productOffer} %`
                    document.getElementById('large-categoryOffer').innerHTML = `${data.product.categoryDetaisl[0].categoryOffer} %`

                    document.getElementById('view-modal-img-1').src = `/images/backend/products/${data.product.sku}/${data.product.productImage[0]}`
                    document.getElementById('view-modal-img-2').src = `/images/backend/products/${data.product.sku}/${data.product.productImage[1]}`
                    document.getElementById('view-modal-img-3').src = `/images/backend/products/${data.product.sku}/${data.product.productImage[2]}`


                    modal.show()
                })()
            })
            .catch((err) => {
                //console.log('error occured while fetching product details', err)
                Swal.fire({
                    title:'Error',
                    title:'error',
                    text:err.message,
                    showConfirmButton:true
                })
            })
        
    }

    //offer management ===> 

    //Add offer
    async function addOffer(productId){
        const {value:offerPercentage} = await Swal.fire({
            title:'Enter offer in percentage',
            input:'number',
            inputLabel:'percentage',
            inputPlaceholder:'%',
            showCancelButton:true
        })
        //console.log('data ready to be fetched')

        fetch('/admin/product/addOffer', {
            method:'POST',
            headers:{
                'content-type':'application/json'
            },
            body:JSON.stringify({
                id:productId,
                offerPercentage:offerPercentage
            })
        }).then((response) => {
            //console.log('response reached here')
            //console.log(response)
            return response.json()
        }).then((data) => {
            if(data.status === true){
                location.reload()
                Swal.fire({
                    title:'Added',
                    icon:'success',
                    text:data.message,
                    showConfirmButton:false,
                    timer:1600
                })
            }else{
                Swal.fire({
                    title:'Failed',
                    icon:'error',
                    text:data.message,
                    showConfirmButton:true
                })
            }
        }).catch((error) => {
            alert(error.message)
            console.log(error)
        })
    }

    //Remove offer
    function removeOffer(productId){
        Swal.fire({
            title:'Remove Offer',
            icon:'warning',
            text:'Are you sure to remov current offer',
            showCancelButton:true,
            showConfirmButton:true,
            confirmButtonText:'Yes, remove it'
        }).then((confirmed) => {
            //console.log('confired ', confirmed)
            if(confirmed.isConfirmed){
                fetch('/admin/product/removeOffer', {
                    method:'POST',
                    headers:{
                        'content-type':'application/json'
                    },
                    body:JSON.stringify({id:productId})
                }).then((response) => {
                    return response.json()
                }).then((data) => {
                    if(data.status === true){
                        Swal.fire({
                            title:'Removed',
                            icon:'success',
                            text:data.message,
                            showConfirmButton:false,
                            timer:1600
                        }).then(() => location.reload())
                    }else{
                        Swal.fire({
                            title:'Failed',
                            icon:'error',
                            text:'Failed to remove the offer'
                        })
                    }
                })
            }
        })
    }
</script>