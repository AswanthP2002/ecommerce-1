<section id="user-profile">
    <div class="container">
        <div class="row gy-3">
            <div class="col-md-7 order-2 order-md-1">
                <div class="card shadow p-3">
                    <p class="fw-bold">My Orders</p>
                    {{#each orders}}
                    <div class="border-bottom border-secondary d-flex justify-content-between p-3">
                        <div>
                            <p>Order Id : <span>{{this.orderId}}</span></p>
                            <p>Date : <span>{{formatDate this.createdAt}}</span></p>
                            <span>Ordered Items : </span>
                            {{#each this.productDetails}}
                            <span>{{this.productName}}</span>,
                            {{/each}}
                            <p>Total Price : <span>{{this.finalAmount}}</span></p>
                            {{#if (isCancelled this.status 'Cancelled')}}
                            <p style="color: red;">Order Status : {{this.status}}</p>
                            {{else}}
                            <p>Order Status : {{this.status}}</p>
                            {{/if}}

                        </div>
                        <div class="d-flex flex-column justify-content-between">
                            {{!-- <img src="/images/backend/products/" alt="" class="d-block bg-secondary" style="width: 80px;height:80px"> --}}
                            <button onclick="orderView('{{this.orderId}}','{{formatDate this.createdAt}}',{{this.productDetails}})" type="button" class="border border-secondary" data-bs-toggle="modal" data-bs-target="#orderViewModal">Action</button>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            <div class="col-md-5 order-1 order-md-2">
                <div class="card shadow p-3" id="profile">
                    <div class="d-flex flex-column align-items-center">
                        <span class="rounded-circle d-flex justify-content-center align-items-center bg-secondary border border-secondary" id="user-profile-icon"><i class="fa-solid fa-user"></i></span>
                        <p class="text-center text-dark fw-bold">{{user.name}}</p>
                    </div>
                    <div>
                        <label for="user-email" class="fw-bold">Email</label>
                        <p id="user-email">{{user.email}}</p>
                    </div>
                    <div>
                        <label for="user-phone" class="fw-bold">Phone</label>
                        <p id="user-phone">{{user.phone}}</p>
                    </div>
                    <button onclick="showUserDetailsPreview('{{user.name}}', '{{user.email}}','{{user.phone}}')" class="btn btn-dark" id="edit-profile-btn" data-bs-toggle="modal" data-bs-target="#profileEditModal">Edit Profile</button>
                </div>
                <div class="card shadow p-3 mt-2" id="address">
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="fw-bold">Address Management</p>
                        <button data-bs-toggle="modal" data-bs-target="#addressAddModal" class="btn btn-primary">Add +</button>
                    </div>
                    <div id="address-list">
                        {{#each address}}
                        <div class="rounded border border-primary mb-1">
                            <p>{{this.building}}, {{this.area}}, {{this.city}}, {{this.state}}, {{this.pinCode}}</p>
                            <a onclick="deleteAddress('{{this._id}}')" href="#"><i class="fa-solid fa-trash"></i></a>
                            <a onclick="fetchEditDetails('{{this._id}}')" href="#"><i class="fa-solid fa-pencil"></i></a>
                            {{!-- Here is a conflict need to be changed the direction of the edit addresss --}}
                        </div>
                        {{/each}}
                    </div>
                </div>
                <div class="d-flex justify-content-between gap-3 mt-2">
                    <div class="card p-3 shadow w-50 d-flex justify-content-center align-items-center">
                        <i class="fa-solid fa-heart"></i><span>My Wishlist</span>
                    </div>
                    <div class="card p-3 shadow w-50 d-flex justify-content-center align-items-center">
                        <i class="fa-solid fa-wallet"></i><span>Wallet</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="addressAddModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header d-flex justify-content-between">
                        <h5 class="modal-title">Add Address</h5>
                        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form action="/profile/address/add?id={{user._id}}" method="post">
                            <input type="text" class="form-control mt-2" name="name" placeholder="full name" required>
                            <input type="tel" class="form-control mt-2" name="phone" placeholder="phone" required>
                            <input type="text" class="form-control mt-2" name="area" placeholder="Road name / Area" required>
                            <input type="text" class="form-control mt-2" name="building" placeholder="House No./Building name" required>
                            <input type="text" class="form-control mt-2" name="city" placeholder="City" required>
                            <input type="text" class="form-control mt-2" name="state" placeholder="State" required>
                            <input type="number" class="form-control mt-2" name="pinCode" placeholder="Pin code" required>
                            <button class="btn btn-primary" type="submit">Save</button>
                            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        
                    </div>
                </div>
            </div>
        </div>

        <div id="addressEditModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header d-flex justify-content-between">
                        <h5 class="modal-title">Edit Address</h5>
                        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form action="/profile/address/edit" method="post" id="addressEditForm">
                            <input type="text" class="form-control mt-2" name="name" placeholder="full name" required id="edit-address-name">
                            {{!-- <input type="tel" class="form-control mt-2" name="phone" placeholder="phone" required id="edit-address-phone"> --}}
                            <input type="text" class="form-control mt-2" name="area" placeholder="Road name / Area" required id="edit-address-area">
                            <input type="text" class="form-control mt-2" name="building" placeholder="House No./Building name" required id="edit-address-building">
                            <input type="text" class="form-control mt-2" name="city" placeholder="City" required id="edit-address-city">
                            <input type="text" class="form-control mt-2" name="state" placeholder="State" required id="edit-address-state">
                            <input type="number" class="form-control mt-2" name="pinCode" placeholder="Pin code" required id="edit-address-pinCode">
                            <button class="btn btn-primary" type="submit">Save</button>
                            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        
                    </div>
                </div>
            </div>
        </div>

        <div id="profileEditModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header d-flex justify-cotent-between">
                        <h5 class="modal-title">Edit Profile</h5>
                        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form action="profile/address/edit?id={{user._id}}" method="post">
                            <label for="">Name</label>
                            <input type="text" class="form-control" name="name" id="user_name">
                            <label for="">Email</label>
                            <input type="email" name="email" class="form-control" id="user_email">
                            <label for="">Phone</label>
                            <input type="tel" name="phone" class="form-control" id="user_phone">
                            <label for="">Current Password</label>
                            <input type="password" name="currentPassword" class="form-control">
                            <label for="">New Passowrd</label>
                            <input type="password" name="newPassword" class="form-control">
                            <label for="">Confirm Password</label>
                            <input type="password" name="confirmpassword" class="form-control">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {{!-- <div class="modal fade" id="orderViewModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="d-flex justify-content-between w-100">
                            <h5>Orders</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                    <div class="modal-body">
                        sample
                    </div>
                </div>
            </div>
        </div> --}}
    </div>
</section>
<script>

    let addressEditModal

    document.addEventListener('DOMContentLoaded', (e) => {
        addressEditModal = new bootstrap.Modal(document.getElementById('addressEditModal'))
    })

    //const addressEditModal = new bootstrap.Modal(document.getElementById('addressEditModal'))

    function deleteAddress(addressId){
        
        Swal.fire({
            title:'Delete Address',
            icon:'warning',
            text:'Do you want to delete the address',
            showConfirmButton:true,
            showCancelButton:true
        }).then((confirmed) => {
            if(confirmed.isConfirmed){
                fetch('/profile/address/delete', {
                    method:'POST',
                    headers:{
                        'content-type':'application/json'
                    },
                    body:JSON.stringify({addressId:addressId})
                }).then((response) => {
                    return response.json()
                }).then((data) => {
                    if(data.success){
                        Swal.fire({
                            title:'Deleted',
                            icon:'success',
                            text:data.message,
                            showConfirmButton:false,
                            timer:1500
                        }).then(() => location.reload())
                    }
                }).catch((error) => {
                    Swal.fire({
                        icon:'error',
                        title:'Error',
                        text:error.message,
                        showConfirmButton:true
                    })
                })
            }
        })
    }

    function showUserDetailsPreview(name, email, phone){
        document.getElementById('user_name').value = name
        document.getElementById('user_email').value = email
        document.getElementById('user_phone').value = phone
    }

    function fetchEditDetails(addressId){
        console.log(`Address id `, addressId)
        fetch(`/profile/address/edit?id=${addressId}`,{
            method:'GET'
        }).then((response) => {
            return response.json()
        }).then((data) => {
            if(data.success){
                document.getElementById('edit-address-name').value = data.editableAddress.name
                //document.getElementById('edit-address-phone').value = data.editableAddress.phone
                document.getElementById('edit-address-building').value = data.editableAddress.building
                document.getElementById('edit-address-area').value = data.editableAddress.area
                document.getElementById('edit-address-city').value = data.editableAddress.city
                document.getElementById('edit-address-state').value = data.editableAddress.state
                document.getElementById('edit-address-pinCode').value = data.editableAddress.pinCode

                addressEditModal.show()

                const addressEditForm = document.getElementById('addressEditForm')
                //getCurrentAction
                const currentAction = addressEditForm.action
                addressEditForm.action = `${currentAction}?addressId=${addressId}`
            }
        })
    }

    function orderView(orders){

        console.log(orders)
    }

</script>